version: '1.0'
steps:

  release_all:
    image: codefresh/cfstep-helm:2.9.1
    working_directory: development-branch/
    environment:
      - GIT_BRANCH=${{CF_BRANCH}}
      - HELM_HOME=${{CF_VOLUME_PATH}}/.helm
    commands:
      - apk add --no-cache ruby make bash git
      - helm init --client-only
      - helm plugin install https://github.com/chartmuseum/helm-push.git
      - export HELM_REPO_ACCESS_TOKEN=$CF_API_KEY
      - export HELM_REPO_AUTH_HEADER=x-access-token
      - helm repo add codefresh $CF_CTX_CF_HELM_DEFAULT_URL
      - make helm/release-all

  gather_deps:
    image: codefresh/cfstep-helm:2.9.1
    working_directory: development-branch/
    environment:
      - GIT_BRANCH=${{CF_BRANCH}}
      - HELM_HOME=${{CF_VOLUME_PATH}}/.helm
    commands:
      - apk add --no-cache ruby make bash git
      - make helm/update-reqs

  deploy:
    image: codefresh/cfstep-helm:2.9.1
    working_directory: development-branch/
    environment:
      - HELM_HOME=${{CF_VOLUME_PATH}}/.helm
      - CHART_REF=.
      - VALUESFILE_overrides=override-values.yaml
      - RELEASE_NAME=development-branch-example
